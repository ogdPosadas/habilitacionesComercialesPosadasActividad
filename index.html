<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa interactivo - Municipalidad de Posadas</title>
    
    <!-- Leaflet y MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!-- fuente de letas -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <!-- pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.3/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>


    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f9fa;
        }

        .container-grid {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        .navbar {
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .main {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 10px;
            padding: 10px;
            height: 100%;
        }

        .infoExtra {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-y: auto;
        }
        #sector-list-container {
            height: 60vh; /* 80% del viewport */
            overflow-y: auto; /* Para hacer scroll si hay muchos sectores */
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background: white;
        }

        #sector-list {
            list-style: none;
            padding: 0;
        }

        #sector-list li {
            cursor: pointer;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }

        #sector-list li:hover {
            background-color: #e0e0e0;
        }   
        .sector-item {
            cursor: pointer;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }

        .sector-item:hover {
            background-color: #e0e0e0;
        }

        /* Resaltar la actividad seleccionada */
        .sector-item.active {
            background-color: #28a745; /* Verde de Bootstrap */
            color: white;
            font-weight: bold;
        }
        .map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .btn-group {
            margin-bottom: 10px;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            z-index: 1; /* Asegura que el mapa quede en el fondo */
        }

        .dropdown-menu {
            z-index: 1050;
        }

        h2 {
            font-size: 1.6vw;
        }
        h3 {
            font-size: 1.2vw;
            margin-top: 10px;
        }
        .btn-group button.active {
            background-color: #2ca25f; /* Color activo */
            color: white;
        }

        .btn-group button.active:hover {
            background-color: #006d2c; /* Color de hover cuando est√° activo */
        }

        .form-control{
            margin-bottom: 10px;
        }
        /* Sacar din√°micamente el formato en busqueda por IDGIS */
        .solo-lectura {
            cursor: default !important;
            pointer-events: none; /* Desactiva cualquier interacci√≥n */
            background-color: transparent !important;
        }

        .solo-lectura:hover {
            background-color: transparent !important;
        }

        /* Estilo para boton de documentacion al seleccionar actividad */
        .btn-resaltado {
            background-color: #2ca25f !important;
            color: white !important;
            border: 2px solid #218c4e !important;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease-in-out;
        }

    </style>
</head>
<body>
    <div class="container-grid">
        <nav class="navbar navbar-dark fixed-top" style="background-color: #003928;">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html" style="padding-left: 10px;">
                    <img src="assets/LOGO POSADAS BLANCO.png" alt="Logo Posadas" width="20%">
                </a>
            </div>
        </nav>
    
        <div class="main">
            <div class="infoExtra" id="infoExtra">
                <h2>Habilitaciones comerciales</h2>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="cambiarModo('idgis')">Buscar por IDGIS</button>
                    <button id="buscar-actividad-btn" class="btn btn-secondary" onclick="cambiarModo('actividad')">Buscar por actividad</button>
                </div>
                <input type="text" id="buscador-idgis" class="form-control" placeholder="Buscar por IDGIS...">
                <input type="text" id="buscador-concepto" class="form-control" placeholder="Buscar por actividad comercial..."
                  style="display:none;">
                <h3 id="titulo_actividades" style="display: none;">Lista de actividades que pueden ser habilitadas</h3>
                <div id="sector-list-container">
                    <ul id="sector-list"></ul>
                </div>
                <button id="ver-documentacion" class="btn btn-secondary" style="display: none; margin-top: 10px;">
                    Ver documentaci√≥n para habilitar la actividad
                </button>
            </div>
            <div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([-27.370373, -55.892994], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            detectRetina: true,
            maxZoom: 18,
            minZoom: 10
        }).addTo(map);

        // Capas base disponibles
        var baseMaps = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                detectRetina: true,
                maxZoom: 18,
                minZoom: 10
            }),
            "OpenStreetMap Humanitarian": L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap France'
            }),
            "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenTopoMap'
            }),
            "ESRI Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            "ESRI Topogr√°fico": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'),
            "Carto Positron": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CartoDB'
            }),
            "Carto Dark Matter": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CartoDB'
            })
        };
    
        var geojsonData;
        var geojsonLayer;
        var actividades = null;
        var geojsonData = null;
        var distritosFiltrados = [];
        var markerCluster = L.markerClusterGroup();

        function asignarEventosBusqueda() {
            document.getElementById("buscador-idgis").removeEventListener("input", buscarPorIDGIS);
            document.getElementById("buscador-concepto").removeEventListener("input", buscarConcepto);

            if (modoActual === 'idgis') {
                document.getElementById("buscador-idgis").addEventListener("input", buscarPorIDGIS);
            } else {
                document.getElementById("buscador-concepto").addEventListener("input", buscarConcepto);
            }
        }

        // let actividades = null; // Variable global para almacenar los datos cargados inicialmente
        function actualizarVista() {
            if (modoActual === 'actividad') {
                actualizarListaSectoresActividad();
            } else {
                actualizarListaSectoresIDGIS();
            }
        }
        function cargarDatos() {
            if (actividades) {
                console.log("Datos ya cargados:", actividades);
                // Si ya se han cargado los datos, simplemente actualiza la vista
                actualizarVista();
                return;
            }

            // Cargar los datos solo la primera vez
            let archivo = 'actividades2.json';
            fetch(archivo)
                .then(response => response.json())
                .then(data => {
                    actividades = data; // Almacenar los datos en la variable global
                    console.log("Datos cargados por primera vez:", actividades);
                    actualizarVista(); // Actualizar la vista despu√©s de cargar los datos
                })
                .catch(error => console.error("Error cargando datos:", error));
        }

        // Llama a cargarDatos cada vez que cambies de modo
        function cambiarModo(modo) {
            modoActual = modo;
            document.getElementById("buscador-idgis").style.display = (modo === 'idgis') ? 'block' : 'none';
            document.getElementById("buscador-concepto").style.display = (modo === 'actividad') ? 'block' : 'none';

            // Actualizar las clases activas en los botones
            const botones = document.querySelectorAll('.btn-group button');
            botones.forEach(boton => boton.classList.remove('active'));

            if (modo === 'idgis') {
                document.querySelector('.btn-group button:nth-child(1)').classList.add('active');
                document.getElementById("ver-documentacion").style.display = "none";
                document.getElementById("titulo_actividades").style.display = "block";

                document.querySelectorAll("#sector-list li").forEach(li => {
                    li.classList.add("solo-lectura");
                });
            } else {
                document.querySelector('.btn-group button:nth-child(2)').classList.add('active');
                document.getElementById("titulo_actividades").style.display = "none";

                document.querySelectorAll("#sector-list li").forEach(li => {
                    li.classList.remove("solo-lectura");
                });

                let verDocumentacionBtn = document.getElementById("ver-documentacion");
                verDocumentacionBtn.classList.remove("btn-resaltado");
                verDocumentacionBtn.classList.add("btn-secondary");
                verDocumentacionBtn.removeAttribute("data-actividad");
            }

            // Cargar o actualizar los datos seg√∫n sea necesario
            cargarDatos();
            asignarEventosBusqueda();
        }


        // Funci√≥n que se ejecuta al cargar la p√°gina para configurar el modo inicial
        window.onload = function () {
            cambiarModo('idgis'); // Activa el modo IDGIS al inicio
        };

        // Funci√≥n auxiliar para actualizar las listas seg√∫n el modo actual
        function actualizarListas() {
            if (modoActual === "actividad") {
                actualizarListaSectoresActividad();
            } else {
                actualizarListaSectoresIDGIS();
            }
        }

        // Crear funci√≥n debounce
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Buscadores
        // IDGIS 
        function buscarPorIDGIS() {
            var idgisSeleccionado = document.getElementById("buscador-idgis").value.trim();
            if (!idgisSeleccionado) {
                distritosFiltrados = [];
                actualizarListaSectoresIDGIS();
                return;
            }
            if (geojsonData) {
                // Buscar en geojsonData el pol√≠gono con el IDGIS seleccionado
                var featureEncontrado = geojsonData.features.find(feature => feature.properties.IDGIS == idgisSeleccionado);

                if (featureEncontrado) {
                    // Obtener el DISTRITO correspondiente
                    distritosFiltrados = [featureEncontrado.properties.DISTRITO.trim().toLowerCase()];
                    let customPopup = `
                    <h2 style="font-size: 1vw;">
                        IDGIS: ${featureEncontrado.properties.IDGIS}
                    </h2>
                    <p>Datos:</p>
                    <ul>
                        <li>Secci√≥n: ${featureEncontrado.properties.SEC}</li>
                        <li>Chacra: ${featureEncontrado.properties.CHA}</li>
                        <li>Manzana: ${featureEncontrado.properties.MAN}</li>
                        <li>Parcela: ${featureEncontrado.properties.PAR}</li>
                        <li>Lote: ${featureEncontrado.properties.LOTE}</li>
                        <li>Distrito: ${featureEncontrado.properties.DISTRITO}</li>
                    </ul>
                    `;
                    // Centrar y hacer zoom en el pol√≠gono
                    var bounds = L.geoJson(featureEncontrado).getBounds();
                    map.fitBounds(bounds, { padding: [50, 50] });

                    // Agregarlo al mapa con estilo resaltado
                    if (geojsonLayer) {
                        map.removeLayer(geojsonLayer);
                    }
                    geojsonLayer = L.geoJson(featureEncontrado, {
                        style: {
                            fillColor: "#006d2c",  // Color resaltado
                            color: "black",
                            weight: 2,
                            fillOpacity: 0.7
                        },
                        onEachFeature: function (feature, layer) {
                            layer.bindPopup(customPopup).openPopup();
                        }
                    }).addTo(map);
                }

                actualizarListaSectoresIDGIS();
            }
        }

        // Actividades
        // Funci√≥n para manejar la b√∫squeda con debounce
        const buscarConcepto = debounce(function() {
            var conceptoSeleccionado = document.getElementById("buscador-concepto").value.trim().toLowerCase();
    
            if (!conceptoSeleccionado) {
                distritosFiltrados = [];
                actualizarListaSectoresActividad();
                return;
            }
    
            // Filtrar en actividades los DISTRITO que tienen el concepto buscado
            distritosFiltrados = actividades
                .filter(a => a.Concepto.toLowerCase().includes(conceptoSeleccionado))
                .map(a => a.DISTRITO.trim().toLowerCase());
    
            // Actualizar lista de sectores con el filtro
            actualizarListaSectoresActividad(conceptoSeleccionado);
    
            // Si hay resultados, filtrar el mapa
            if (distritosFiltrados.length > 0) {
                filtrarMapaActividades(conceptoSeleccionado);
                resaltarSeleccion(conceptoSeleccionado);
            } else {
                // Si no hay coincidencias, limpiar el mapa y lista
                filtrarMapaActividades(null);
                resaltarSeleccion(null);
            }
        }, 400);  // 400 ms de retraso
        
        // Actualizar lista de sectores dependiendo si es actividad o IDGIS
        // Llenar la lista en infoExtra con actividades
        function actualizarListaSectoresActividad(filtroTexto = "") {
            var listaSectores = document.getElementById("sector-list");
            let fragment = document.createDocumentFragment(); // Fragmento para mejorar rendimiento

            var actividadesFiltradas = actividades.filter(a => 
                distritosFiltrados.length > 0 
                    ? distritosFiltrados.includes(a.DISTRITO.trim().toLowerCase())
                    : true
            );

            var actividadesUnicas = [...new Set(actividadesFiltradas
                .map(a => a.Concepto)
                .filter(concepto => concepto.toLowerCase().includes(filtroTexto))
            )];

            listaSectores.innerHTML = ""; // Limpiar la lista antes de agregar nuevos elementos

            // Agregar opci√≥n "Ninguno"
            var opcionNinguno = document.createElement("li");
            opcionNinguno.textContent = "Ninguno";
            opcionNinguno.classList.add("sector-item");
            opcionNinguno.addEventListener("click", function() {
                filtrarMapaActividades(null);
                resaltarSeleccion(null);
            });
            fragment.appendChild(opcionNinguno); // Agregar al fragmento en lugar del DOM directamente

            // Agregar actividades filtradas a la lista usando el fragmento
            actividadesUnicas.forEach(actividad => {
                var li = document.createElement("li");
                li.textContent = actividad;
                li.classList.add("sector-item");
                li.addEventListener("click", function() {
                    filtrarMapaActividades(actividad);
                    resaltarSeleccion(actividad);
                });
                fragment.appendChild(li);
            });

            listaSectores.appendChild(fragment); // Agregar todo el fragmento de una sola vez

            if (distritosFiltrados.length === 0) {
                cargarGeoJSON(null);
            }
        }

        // sectores de IDGIS
        function actualizarListaSectoresIDGIS() {
            var listaSectores = document.getElementById("sector-list");
            
            // Si hay filtro de IDGIS, se filtran actividades seg√∫n los distritos encontrados
            var actividadesFiltradas = distritosFiltrados.length > 0 
                ? actividades.filter(a => distritosFiltrados.includes(a.DISTRITO.trim().toLowerCase()))
                : actividades;

            var actividadesUnicas = [...new Set(actividadesFiltradas.map(a => a.Concepto))];

            // Limpiar opciones anteriores
            listaSectores.innerHTML = "";

            // Agregar opci√≥n "Ninguno"
            var opcionNinguno = document.createElement("li");
            opcionNinguno.textContent = actividadesUnicas[0];
            
            // Si estamos en IDGIS, deshabilitar interacci√≥n
            if (modoActual === "idgis") {
                opcionNinguno.classList.add("solo-lectura");
            } else {
                opcionNinguno.classList.add("sector-item"); // Mantener interacci√≥n en "Buscar por Actividad"
            }

            listaSectores.appendChild(opcionNinguno);

            // Agregar las actividades √∫nicas filtradas
            actividadesUnicas.slice(1).forEach(actividad => {
                var li = document.createElement("li");
                li.textContent = actividad;

                if (modoActual === "idgis") {
                    li.classList.add("solo-lectura");
                } else {
                    li.classList.add("sector-item"); // Clase para resaltar selecci√≥n solo en "Buscar por Actividad"
                }

                listaSectores.appendChild(li);
            });

            // Si no hay filtro por IDGIS, cargar todos los sectores en el mapa
            if (distritosFiltrados.length === 0) {
                cargarGeoJSON(null);
            }
        }

        // Funci√≥n para resaltar la actividad seleccionada
        function resaltarSeleccion(actividadSeleccionada) {
            document.querySelectorAll("#sector-list li").forEach(li => {
                if (li.textContent === actividadSeleccionada) {
                    li.style.backgroundColor = "#4CAF50"; // Verde para destacar
                    li.style.color = "white";
                } else {
                    li.style.backgroundColor = "";
                    li.style.color = "";
                }
            });
            // Mostrar el bot√≥n solo si hay una actividad seleccionada
            let btnDocumentacion = document.getElementById("ver-documentacion");
            if (actividadSeleccionada) {
                btnDocumentacion.style.display = "block";
                btnDocumentacion.setAttribute("data-actividad", actividadSeleccionada); // Guardar la actividad seleccionada
            } else {
                btnDocumentacion.style.display = "none";
            }
        }

        // Cargar el archivo GeoJSON
        var geojsonLayer;
        var layerControl = L.control.layers(baseMaps, null, { collapsed: true }).addTo(map);
        var secciones = {}; // Almacena las capas de cada secci√≥n   

        function cargarGeoJSON(actividadInicial) {
            fetch('secciones_unificado.geojson')
                .then(response => response.json())
                .then(data => {
                    geojsonData = data;
                    data.features.forEach(feature => {
                        let sec = feature.properties.SEC;
                        if (!sec || sec === "null") return; // Ignorar valores nulos
                        if (!secciones[sec]) {
                            secciones[sec] = L.layerGroup();
                        }
                        let layer = L.geoJson(feature, {
                            style: { color: '#006d2c', weight: 2 },
                            onEachFeature: function (feature, layer) {
                                let customPopupLayerC = `
                                    <h2 style="font-size: 1vw;">
                                        IDGIS: ${feature.properties.IDGIS}
                                    </h2>
                                    <p>Datos:</p>
                                    <ul>
                                        <li>Secci√≥n: ${feature.properties.SEC}</li>
                                        <li>Chacra: ${feature.properties.CHA}</li>
                                        <li>Manzana: ${feature.properties.MAN}</li>
                                        <li>Parcela: ${feature.properties.PAR}</li>
                                        <li>Lote: ${feature.properties.LOTE}</li>
                                        <li>Distrito: ${feature.properties.DISTRITO}</li>
                                    </ul>
                                    `;
                                layer.bindPopup(customPopupLayerC);
                            }
                        });
                        secciones[sec].addLayer(layer);
                    });
                    
                    // Ordenar secciones num√©ricamente y agregarlas al layer control
                    Object.keys(secciones).sort().forEach(sec => {
                        layerControl.addOverlay(secciones[sec], `Secci√≥n ${sec}`);
                    });
                
                    if (modoActual === 'actividad') {
                        filtrarMapaActividades(actividadInicial);
                    } else {
                        filtrarMapaIDGIS(actividadInicial);
                    }
                })
                .catch(error => console.error("Error cargando el GeoJSON:", error));
        }

        // filtrar mapas 
        // Actividades
        function filtrarMapaActividades(actividadSeleccionada) {
            if (!actividadSeleccionada) {
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                }
                markerCluster.clearLayers();
                return;
            }
    
            var distritosFiltrados = actividades
                .filter(a => a.Concepto.toLowerCase() === actividadSeleccionada.toLowerCase())
                .map(a => a.DISTRITO ? a.DISTRITO.trim().toLowerCase() : "");
    
            if (!geojsonData) {
                console.error("GeoJSON a√∫n no est√° cargado.");
                return;
            }
    
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }
            markerCluster.clearLayers();
    
            geojsonLayer = L.geoJson(geojsonData, {
                filter: function(feature) {
                    var distritoGeo = feature.properties.DISTRITO ? feature.properties.DISTRITO.trim().toLowerCase() : "";
                    return distritosFiltrados.includes(distritoGeo);
                },
                style: function(feature) {
                    return {
                        fillColor: "#006d2c",
                        color: "black",
                        weight: 1,
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.DISTRITO) {
                        let customPopup = `
                        <h2 style="font-size: 1vw;">
                            IDGIS: ${feature.properties.IDGIS}
                        </h2>
                        <p>Datos:</p>
                        <ul>
                            <li>Secci√≥n: ${feature.properties.SEC}</li>
                            <li>Chacra: ${feature.properties.CHA}</li>
                            <li>Manzana: ${feature.properties.MAN}</li>
                            <li>Parcela: ${feature.properties.PAR}</li>
                            <li>Lote: ${feature.properties.LOTE}</li>
                            <li>Distrito: ${feature.properties.DISTRITO}</li>
                        </ul>
                        `;
                        layer.bindPopup(customPopup);
                    }
                    markerCluster.addLayer(layer);
                }
            });
    
            map.addLayer(markerCluster);
            map.addLayer(geojsonLayer);
        }

        // IDGIS
        // Filtrar y actualizar el mapa basado en la actividad seleccionada
        function filtrarMapaIDGIS(actividadForzada = null) {
            var actividadSeleccionada = actividadForzada;

            if (!actividadSeleccionada) {
                // Si es "Ninguno", limpiar el mapa completamente
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                }
                markerCluster.clearLayers();
                return;
            }

            var distritosFiltrados = actividades
                .filter(a => a.Actividad === actividadSeleccionada)
                .map(a => a.DISTRITO ? a.DISTRITO.trim().toLowerCase() : "");

            if (!geojsonData) {
                console.error("GeoJSON a√∫n no est√° cargado.");
                return;
            }

            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }
            markerCluster.clearLayers();

            geojsonLayer = L.geoJson(geojsonData, {
                filter: function(feature) {
                    var distritoGeo = feature.properties.DISTRITO ? feature.properties.DISTRITO.trim().toLowerCase() : "";
                    return distritosFiltrados.includes(distritoGeo);
                },
                style: function(feature) {
                    return {
                        fillColor: "#006d2c",
                        color: "black",
                        weight: 1,
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.DISTRITO) {
                        let customPopup = `
                        <h2 style="font-size: 1vw;">
                            IDGIS: ${feature.properties.IDGIS}
                        </h2>
                        <p>Datos:</p>
                        <ul>
                            <li>Secci√≥n: ${feature.properties.SEC}</li>
                            <li>Chacra: ${feature.properties.CHA}</li>
                            <li>Manzana: ${feature.properties.MAN}</li>
                            <li>Parcela: ${feature.properties.PAR}</li>
                            <li>Lote: ${feature.properties.LOTE}</li>
                            <li>Distrito: ${feature.properties.DISTRITO}</li>
                        </ul>
                        `;
                        layer.bindPopup(customPopup);
                    }
                    markerCluster.addLayer(layer);
                }
            });

            map.addLayer(markerCluster);
            map.addLayer(geojsonLayer);
        }

        // documentacion requerida
        document.getElementById("ver-documentacion").addEventListener("click", function () {
            let actividadSeleccionada = this.getAttribute("data-actividad");
            if (!actividadSeleccionada) return;

            // Cargar datos de actividades2.json para obtener el riesgo de habilitaci√≥n
            fetch("actividades2.json")
                .then(response => response.json())
                .then(actividades => {
                    let actividadInfo = actividades.find(a => a.Concepto === actividadSeleccionada);
                    if (!actividadInfo) {
                        alert("Debe seleccionar una actividad primero.");
                        return;
                    }

                    // let riesgo = actividadInfo.RIESGO || "No disponible";
                    // Filtrar todas las filas de la actividad seleccionada en actividades2.json
                    let paquetesUnicos = new Set(
                        actividades
                            .filter(a => a.Concepto === actividadSeleccionada) // Obtener todas las filas de la actividad
                            .map(a => a["PAQUETE DE DOC REQUERIDA"]) // Extraer los paquetes de documentaci√≥n
                    );

                    // Convertir el Set a un array y unir los paquetes en un string separado por comas (opcional)
                    let paqueteDoc = [...paquetesUnicos].join(", ");
                    // Filtrar las filas que corresponden a la actividad seleccionada
                    var actividadData = actividades.filter(a => a.Concepto === actividadSeleccionada);
                    // Extraer el riesgo (solo una vez, tomando el primero)
                    var riesgo = actividadData.length > 0 ? actividadData[0].RIESGO : "No disponible";

                    // Cargar documentaci√≥n
                    fetch("documentacion.json")
                        .then(response => response.json())
                        .then(documentacion => {
                            let paquetesArray = [...paquetesUnicos]; // Convertimos el Set en un array
                            let docsFiltradas = documentacion.filter(d => paquetesArray.includes(d["PAQUETE DE DOC REQUERIDA"]));    
                            let paquetesAgrupados = new Map();
                            // Agrupar la documentaci√≥n por paquete
                            docsFiltradas.forEach(doc => {
                                let paquete = doc["PAQUETE DE DOC REQUERIDA"];
                                let documento = doc["Documentaci√≥n"];

                                if (!paquetesAgrupados.has(paquete)) {
                                    paquetesAgrupados.set(paquete, new Set()); // Usamos Set para evitar duplicados
                                }
                                paquetesAgrupados.get(paquete).add(documento);
                            });
                            // Construir la ventana emergente
                            let contenido = `<h2>${actividadSeleccionada}</h2>`;
                            contenido += `<p><strong>Tipo de riesgo:</strong> ${riesgo}</p>`;
                            contenido += `<h3>Documentaci√≥n necesaria para habilitar la actividad</h3>`;

                            // Generar el contenido asegurando que todos los paquetes sean incluidos
                            paquetesAgrupados.forEach((documentos, paquete) => {
                                contenido += `<p><strong>${paquete}</strong></p><ul>`;
                                documentos.forEach(doc => {
                                    contenido += `<li>${doc}</li>`;
                                });
                                contenido += `</ul>`;
                            });

                            // Crear el cartel interactivo
                            let modal = document.createElement("div");
                            modal.innerHTML = `
                                <div id="modal-overlay" style="
                                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                                    background: rgba(0, 0, 0, 0.5); z-index: 1000;
                                    display: flex; justify-content: center; align-items: center;">
                                    
                                    <div id="modal-content" style="
                                        background: white; padding: 20px; border-radius: 8px; 
                                        width: 90%; max-width: 700px; max-height: 100%; overflow-y: auto;
                                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); 
                                        position: relative; text-align: justify;">
                                        
                                        <!-- Bot√≥n de cierre "X" en la esquina superior derecha -->
                                        <nav class="navbar" style="background-color: white;">
                                            <div class="container-fluid">
                                                <a class="navbar-brand" href="index.html" style="padding-left: 10px; text-align:center">
                                                    <img src="assets/Escudo-posadas-secre-y-muni.png" alt="Logo Posadas" width="80%">
                                                </a>
                                            </div>
                                        </nav>
                                        ${contenido}
                                        <!-- Bot√≥n para descargar como PDF -->
                                        <button class="btn btn-primary" id="descargar-pdf" style="margin-top: 20px; padding: 10px; background-color: #2ca25f; color: white; border: none; border-radius: 5px;">
                                            Descargar PDF
                                        </button>
                                    </div>
                                </div>
                                <!-- Bot√≥n de cierre "X" fuera de la ventana modal -->
                                <button id="cerrar-modal" style="
                                    position: fixed; top: 10px; right: 10px; 
                                    background: none; border: none; font-size: 20px; 
                                    cursor: pointer; color: white; z-index: 1100;">‚úñ</button>
                            `;
                            document.body.appendChild(modal);
                            
                            document.getElementById("descargar-pdf").addEventListener("click", function() {
                                // Ocultar temporalmente los botones
                                const cerrarBtn = document.getElementById("cerrar-modal");
                                const descargarBtn = document.getElementById("descargar-pdf");
                                if (cerrarBtn) cerrarBtn.style.display = "none";
                                descargarBtn.style.display = "none";

                                const element = document.getElementById("modal-content");

                                // Ajustar estilos CSS para centrar el contenido
                                const contentWidth = 210 - 20; // Ancho de la p√°gina A4 menos m√°rgenes
                                element.style.width = `${contentWidth}mm`;
                                element.style.margin = "0 auto";

                                const opt = {
                                    margin: [10, 10, 10, 10],  // M√°rgenes superior, derecho, inferior, izquierdo
                                    filename: 'Documentaci√≥n requerida.pdf',
                                    image: { type: 'jpeg', quality: 0.98 },
                                    html2canvas: { scale: 2, useCORS: true },
                                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                                };

                                html2pdf().set(opt).from(element).save().then(function() {
                                    // Volver a mostrar los botones
                                    if (cerrarBtn) cerrarBtn.style.display = "block";
                                    descargarBtn.style.display = "block";

                                    // Restaurar estilos CSS originales
                                    element.style.width = "";
                                    element.style.margin = "";
                                }).catch(function(error) {
                                    console.error('Error al generar el PDF:', error);
                                    // Volver a mostrar los botones si ocurre un error
                                    if (cerrarBtn) cerrarBtn.style.display = "block";
                                    descargarBtn.style.display = "block";

                                    // Restaurar estilos CSS originales
                                    element.style.width = "";
                                    element.style.margin = "";
                                });
                            });



                            // Cerrar modal al hacer clic en el bot√≥n
                            setTimeout(() => {
                                document.getElementById("cerrar-modal").addEventListener("click", function () {
                                    modal.remove(); // Elimina el modal completamente del DOM
                                });
                            }, 100);
                        })
                        .catch(error => console.error("Error cargando la documentaci√≥n:", error));
                }).catch(error => console.error("Error cargando las actividades:", error)
            );
        });

        document.addEventListener("DOMContentLoaded", function () {
            let sectorList = document.getElementById("sector-list"); // Lista de actividades en "Buscar por Actividad"
            let buscarPorActividadBtn = document.getElementById("buscar-actividad-btn"); // Bot√≥n para activar "Buscar por Actividad"
            let buscarPorActividadInput = document.getElementById("buscador-concepto"); // Input de b√∫squeda por actividad
            let buscarPorIDGISInput = document.getElementById("buscador-idgis"); // Input de b√∫squeda por IDGIS
            let verDocumentacionBtn = document.getElementById("ver-documentacion"); // Bot√≥n de ver documentaci√≥n
            let modoBusqueda = "actividad"; // Variable para rastrear el estado de b√∫squeda

            // segurar que el bot√≥n est√° oculto al inicio
            verDocumentacionBtn.style.display = "none";

            // Evento: Al hacer clic en "Buscar por Actividad", activar este modo y mostrar el bot√≥n
            buscarPorActividadBtn.addEventListener("click", function () {
                modoBusqueda = "actividad"; // Cambiar el estado a "actividad"
                verDocumentacionBtn.style.display = "block"; // Mostrar bot√≥n
                verDocumentacionBtn.removeAttribute("data-actividad"); // Limpiar actividad seleccionada
            });

            // üîπ Evento: Si el usuario cambia a "Buscar por IDGIS", ocultar el bot√≥n
            buscarPorIDGISInput.addEventListener("focus", function () {
                modoBusqueda = "idgis"; // Cambiar el estado a "idgis"
                verDocumentacionBtn.style.display = "none"; // Ocultar el bot√≥n
                verDocumentacionBtn.removeAttribute("data-actividad");
            });

            // Evento: SOLO permitir la selecci√≥n de actividades en "Buscar por Actividad"
            // Funci√≥n para manejar el clic en la lista
            document.getElementById("sector-list").addEventListener("click", function(event) {
                if (event.target.tagName === "LI") {
                    let actividadSeleccionada = event.target.textContent.trim();

                    // Verificar que estamos en "Buscar por Actividad"
                    if (modoActual === "actividad") {
                        verDocumentacionBtn.style.display = "block";  // Mostrar el bot√≥n en modo actividad
                        verDocumentacionBtn.setAttribute("data-actividad", actividadSeleccionada); // Asociar la actividad seleccionada
                    } else {
                        verDocumentacionBtn.style.display = "none";  // Asegurar que el bot√≥n se oculta en modo IDGIS
                    }
                }
            });

            // Evento: Mostrar la documentaci√≥n solo si hay una actividad seleccionada
            verDocumentacionBtn.addEventListener("click", function () {
                let actividadSeleccionada = this.getAttribute("data-actividad");

                if (!actividadSeleccionada) {
                    alert("Debe seleccionar una actividad primero.");
                    return;
                }

                // Llamar a la funci√≥n que muestra la documentaci√≥n
                mostrarDocumentacion(actividadSeleccionada);
            });

            // Funci√≥n para mostrar la documentaci√≥n
            function mostrarDocumentacion(actividad) {
                console.log("Mostrando documentaci√≥n para:", actividad);
                // Aqu√≠ puedes abrir un modal o generar la documentaci√≥n requerida
            }
        });

        // color para listado de ver documentaci√≥n
        // crear el evento al hacer click en un sector
        document.getElementById("sector-list").addEventListener("click", function (event) {
            let verDocumentacionBtn = document.getElementById("ver-documentacion");

            if (modoActual === "actividad" && event.target.tagName === "LI") {
                let actividadSeleccionada = event.target.textContent.trim();

                // Agregar clase de resaltado y cambiar estilos
                verDocumentacionBtn.classList.remove("btn-secondary");
                verDocumentacionBtn.classList.add("btn-resaltado");
                verDocumentacionBtn.setAttribute("data-actividad", actividadSeleccionada);
            }
        });
        // Restablecer estilos al cambiar de modo o hacer clic fuera
        document.addEventListener("click", function (event) {
            // Verificar que el evento se activa
            let verDocumentacionBtn = document.getElementById("ver-documentacion");
            let sectorList = document.getElementById("sector-list");
            let opcionNinguno = document.querySelector("#sector-list li:first-child"); // Primer <li> ("Ninguno")

            if (modoActual === "actividad") {
                // Si hizo clic en "Ninguno", solo quitar el resaltado sin ocultar el bot√≥n
                if (event.target === opcionNinguno) {
                    console.log("üü° Se hizo clic en 'Ninguno', deseleccionando actividad.");
                    verDocumentacionBtn.classList.remove("btn-resaltado");
                    verDocumentacionBtn.classList.add("btn-secondary");
                    verDocumentacionBtn.removeAttribute("data-actividad");
                }
            }
            if (modoActual === "idgis") {
                verDocumentacionBtn.classList.remove("btn-resaltado");
                verDocumentacionBtn.classList.add("btn-secondary");
                verDocumentacionBtn.removeAttribute("data-actividad");
            }
        });
    </script>
</body>
</html>
